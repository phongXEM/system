name: CI/CD - SYSTEM

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            - name: Build docker Image
              run: docker build --progress=plain -t phongxem/next-system:0.1.0 .
            - name: Sign in to Docker Hub
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            - name: Push Image to Docker Hub
              run: docker push phongxem/next-system:0.1.0
    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Executing remote ssh command using password
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  password: ${{ secrets.VPS_PASSWORD }}
                  port: 2405
                  script: |
                      docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
                      docker rm soc-system -f
                      docker rmi phongxem/next-system:0.1.0
                      docker pull phongxem/next-system:0.1.0
                      docker network rm soc-system
                      docker network create soc-system
                      docker run -dp 3000:3000 --name soc-system --network=soc-system --restart unless-stopped phongxem/next-system:0.1.0
